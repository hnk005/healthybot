var D=s=>{throw TypeError(s)};var L=(s,e,t)=>e.has(s)||D("Cannot "+t);var a=(s,e,t)=>(L(s,e,"read from private field"),t?t.call(s):e.get(s)),E=(s,e,t)=>e.has(s)?D("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),O=(s,e,t,r)=>(L(s,e,"write to private field"),r?r.call(s,t):e.set(s,t),t),P=(s,e,t)=>(L(s,e,"access private method"),t);import{S as J,P as Q,Q as _,T as $,V as K,W as z,r as m,X as F,Y as X,B,D as n,Z as U,C as Y,$ as Z,a0 as q,a1 as G,a2 as ee}from"./index-B7wwjnbK.js";import{l as te,u as se}from"./useChatHistory-CNVuEuXE.js";var v,C,d,b,w,T,A,I,re=(I=class extends J{constructor(e,t){super();E(this,w);E(this,v);E(this,C);E(this,d);E(this,b);O(this,v,e),this.setOptions(t),this.bindMethods(),P(this,w,T).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){var r;const t=this.options;this.options=a(this,v).defaultMutationOptions(e),Q(this.options,t)||a(this,v).getMutationCache().notify({type:"observerOptionsUpdated",mutation:a(this,d),observer:this}),t!=null&&t.mutationKey&&this.options.mutationKey&&_(t.mutationKey)!==_(this.options.mutationKey)?this.reset():((r=a(this,d))==null?void 0:r.state.status)==="pending"&&a(this,d).setOptions(this.options)}onUnsubscribe(){var e;this.hasListeners()||(e=a(this,d))==null||e.removeObserver(this)}onMutationUpdate(e){P(this,w,T).call(this),P(this,w,A).call(this,e)}getCurrentResult(){return a(this,C)}reset(){var e;(e=a(this,d))==null||e.removeObserver(this),O(this,d,void 0),P(this,w,T).call(this),P(this,w,A).call(this)}mutate(e,t){var r;return O(this,b,t),(r=a(this,d))==null||r.removeObserver(this),O(this,d,a(this,v).getMutationCache().build(a(this,v),this.options)),a(this,d).addObserver(this),a(this,d).execute(e)}},v=new WeakMap,C=new WeakMap,d=new WeakMap,b=new WeakMap,w=new WeakSet,T=function(){var t;const e=((t=a(this,d))==null?void 0:t.state)??$();O(this,C,{...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset})},A=function(e){K.batch(()=>{var t,r,i,l,c,u,f,p;if(a(this,b)&&this.hasListeners()){const h=a(this,C).variables,y=a(this,C).context;(e==null?void 0:e.type)==="success"?((r=(t=a(this,b)).onSuccess)==null||r.call(t,e.data,h,y),(l=(i=a(this,b)).onSettled)==null||l.call(i,e.data,null,h,y)):(e==null?void 0:e.type)==="error"&&((u=(c=a(this,b)).onError)==null||u.call(c,e.error,h,y),(p=(f=a(this,b)).onSettled)==null||p.call(f,void 0,e.error,h,y))}this.listeners.forEach(h=>{h(a(this,C))})})},I);function ne(s,e){const t=z(),[r]=m.useState(()=>new re(t,s));m.useEffect(()=>{r.setOptions(s)},[r,s]);const i=m.useSyncExternalStore(m.useCallback(c=>r.subscribe(K.batchCalls(c)),[r]),()=>r.getCurrentResult(),()=>r.getCurrentResult()),l=m.useCallback((c,u)=>{r.mutate(c,u).catch(F)},[r]);if(i.error&&X(r.options.throwOnError,[i.error]))throw i.error;return{...i,mutate:l,mutateAsync:i.mutate}}/**
 * @license lucide-react v0.479.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m16 12-4-4-4 4",key:"177agl"}],["path",{d:"M12 16V8",key:"1sbj14"}]],ie=B("CircleArrowUp",ae);/**
 * @license lucide-react v0.479.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],ce=B("CirclePlus",oe);/**
 * @license lucide-react v0.479.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=[["rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",key:"zuxfzm"}],["rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",key:"1okwgv"}]],ue=B("Pause",le),he=({user:s,assistant:e})=>n.jsxs("div",{className:"w-full mx-auto p-4 bg-white",children:[s&&n.jsx("div",{className:"flex justify-end",children:n.jsx("div",{className:"p-2 rounded-lg text-base bg-primary text-white",children:n.jsx("span",{className:"break-words",children:s})})}),e&&n.jsxs("div",{className:"flex items-start space-x-2 w-full mt-10",children:[n.jsx("img",{className:"w-9 h-9 rounded-full",src:te,alt:"logo"}),n.jsx("div",{className:"flex max-w-xl text-gray-500 text-base bg-gray-100 p-2 rounded-lg",children:n.jsx("span",{className:"break-words",children:e.split("<br />").map((t,r)=>n.jsxs("span",{children:[t,n.jsx("br",{})]},r))})})]})]});function de(s){const e=new TextDecoder,t=new TextEncoder;let r="";const i=new TransformStream({async transform(l,c){var g,S,j;const u=e.decode(l,{stream:!0}),f=r+u;let p="";const h=f.split(`
`);f.endsWith(`
`)||(p=h.pop()??"");let y="";for(const M of h){const N=M.trim();if(N&&N.startsWith("data:")){const o=N.slice(5).trim();if(o==="[DONE]")continue;try{const x=JSON.parse(o.replace(/\\n/g,"<br />")),k=(j=(S=(g=x==null?void 0:x.choices)==null?void 0:g[0])==null?void 0:S.delta)==null?void 0:j.content;typeof k=="string"&&(y+=k)}catch(x){console.error("Lỗi JSON:",x,"Dữ liệu lỗi:",o)}}}r=p,c.enqueue(t.encode(y))},flush(l){r&&l.enqueue(t.encode(r))}});return s.pipeThrough(i)}const me=U.create({baseURL:"http://192.168.1.23:5000"}),fe=async(s,e,t)=>{let r=0;try{await me.post("/v1/chat/completions",{model:"Vistral-7B-Chat",messages:[{role:"user",content:s}],max_tokens:200,stream:!0},{responseType:"text",cancelToken:t,onDownloadProgress:i=>{const c=i.event.target.responseText,u=c.substring(r);r=c.length;const f=new ReadableStream({start(g){g.enqueue(new TextEncoder().encode(u)),g.close()}}),h=de(f).getReader(),y=new TextDecoder;h.read().then(({value:g,done:S})=>{if(S)return;const j=y.decode(g,{stream:!0});j&&e(j)})}})}catch(i){U.isCancel(i)?console.log("Chat request bị hủy!"):console.error("Lỗi trong chatWithAIStream:",i)}},V=m.createContext({}),xe=({children:s})=>{const{isUser:e}=Y(),{currentChatId:t}=se(),[r,i]=m.useState(""),[l,c]=m.useState([]),[u,f]=m.useState(!1),p=m.useRef(null),{refetch:h}=Z({queryKey:["listChat"],queryFn:async()=>{const{data:o}=await ee(t);return c(o),o},enabled:!1,retry:!1}),{mutate:y,isPaused:g,isPending:S}=ne({mutationFn:async o=>{f(!0),p.current=U.CancelToken.source();let x="";try{await fe(o,k=>{f(!1),x+=k,c(H=>{const R=[...H];return R[R.length-1].assistant=x,[...R]})},p.current.token)}catch(k){console.error("Request bị hủy:",k)}finally{f(!1),j()}}}),j=async()=>{try{const{user:o,assistant:x}=l[l.length-1];await G(t,o,x)}catch(o){q.error(JSON.stringify(o))}},M=o=>{if(l.length>5&&!e){q.warn("Vui lòng đăng nhập để có thể tiếp tục chat");return}e||q.warn("Đoạn chat của bạn sẽ không được lưu, Vui lòng đăng nhập"),c(x=>[...x,{user:o,assistant:""}]),y(o)},N=()=>{p.current&&p.current.cancel("Người dùng đã hủy request!"),f(!1)};return m.useEffect(()=>{const o=()=>{N()};return window.addEventListener("beforeunload",o),()=>{window.removeEventListener("beforeunload",o)}},[]),m.useEffect(()=>(t&&h(),()=>{N()}),[t,h]),n.jsx(V.Provider,{value:{prompt:r,setPrompt:i,listChat:l,loadingResAt:u,isPending:S,isPaused:g,sendMessage:M,stopChat:N},children:s})},W=()=>{const s=m.useContext(V);if(!s)throw new Error("useChat must be used within ChatBotProvider");return s},pe=()=>{const{listChat:s,loadingResAt:e}=W();return s.length?n.jsx("div",{className:"w-full h-[768px] overflow-y-auto",children:n.jsx("div",{className:"min-w-[768px] max-md:min-w-full flex justify-center",children:n.jsxs("div",{className:"flex flex-col w-full max-w-2xl space-y-3 mb-4 ",children:[s.map((t,r)=>n.jsx(he,{user:t.user,assistant:t.assistant},r)),e&&n.jsx("span",{children:"Vui lòng chờ...."})]})})}):n.jsx("div",{className:"w-full text-center text-4xl p-4",children:n.jsx("h1",{children:"Tôi có thể giúp gì cho sức khỏe của bạn"})})},ye=()=>{const{prompt:s,setPrompt:e,sendMessage:t,stopChat:r,isPending:i,isPaused:l}=W(),c=u=>{u.preventDefault(),!(!s.trim()||i)&&(t(s),e(""))};return n.jsx("div",{className:"flex w-full justify-center items-center",children:n.jsxs("form",{onSubmit:c,className:"flex items-center justify-between min-w-[768px] bg-gradient-to-r from-primary to-blue-600 rounded-full px-4 py-2 shadow-md",children:[n.jsx("button",{type:"button",className:"p-2 text-white hover:opacity-70",children:n.jsx(ce,{className:"w-8 h-8"})}),n.jsx("input",{type:"text",className:"flex-1 bg-white px-4 py-1 rounded-full outline-none text-gray-700 mx-4",placeholder:"Hỏi bất cứ điều gì về sức khỏe của bạn",value:s,onChange:u=>e(u.target.value)}),i&&!l?n.jsx("button",{type:"button",className:"p-2 text-white hover:opacity-70",onClick:r,children:n.jsx(ue,{})}):n.jsx("button",{type:"submit",className:"p-2 text-white hover:opacity-70",children:n.jsx(ie,{className:"w-8 h-8"})})]})})},ve=()=>n.jsx("div",{className:"w-full h-full flex flex-col justify-center items-center",children:n.jsxs(xe,{children:[n.jsx(pe,{}),n.jsx(ye,{})]})});export{ve as default};
