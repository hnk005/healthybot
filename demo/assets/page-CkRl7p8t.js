var I=t=>{throw TypeError(t)};var z=(t,e,s)=>e.has(t)||I("Cannot "+s);var o=(t,e,s)=>(z(t,e,"read from private field"),s?s.call(t):e.get(t)),M=(t,e,s)=>e.has(t)?I("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),R=(t,e,s,r)=>(z(t,e,"write to private field"),r?r.call(t,s):e.set(t,s),s),T=(t,e,s)=>(z(t,e,"access private method"),s);import{S as Z,P as ee,Q as K,T as te,V as Q,W as se,r as i,X as re,Y as ne,Z as W,$ as B,a0 as ae,B as V,D as n,a1 as $,C as ie,a2 as oe,a3 as F,a4 as ce,a5 as le}from"./index-NKgvYUn1.js";import{l as ue,u as he}from"./useChatHistory-D40e83Nh.js";var N,O,y,C,E,_,D,H,de=(H=class extends Z{constructor(e,s){super();M(this,E);M(this,N);M(this,O);M(this,y);M(this,C);R(this,N,e),this.setOptions(s),this.bindMethods(),T(this,E,_).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){var r;const s=this.options;this.options=o(this,N).defaultMutationOptions(e),ee(this.options,s)||o(this,N).getMutationCache().notify({type:"observerOptionsUpdated",mutation:o(this,y),observer:this}),s!=null&&s.mutationKey&&this.options.mutationKey&&K(s.mutationKey)!==K(this.options.mutationKey)?this.reset():((r=o(this,y))==null?void 0:r.state.status)==="pending"&&o(this,y).setOptions(this.options)}onUnsubscribe(){var e;this.hasListeners()||(e=o(this,y))==null||e.removeObserver(this)}onMutationUpdate(e){T(this,E,_).call(this),T(this,E,D).call(this,e)}getCurrentResult(){return o(this,O)}reset(){var e;(e=o(this,y))==null||e.removeObserver(this),R(this,y,void 0),T(this,E,_).call(this),T(this,E,D).call(this)}mutate(e,s){var r;return R(this,C,s),(r=o(this,y))==null||r.removeObserver(this),R(this,y,o(this,N).getMutationCache().build(o(this,N),this.options)),o(this,y).addObserver(this),o(this,y).execute(e)}},N=new WeakMap,O=new WeakMap,y=new WeakMap,C=new WeakMap,E=new WeakSet,_=function(){var s;const e=((s=o(this,y))==null?void 0:s.state)??te();R(this,O,{...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset})},D=function(e){Q.batch(()=>{var s,r,a,c,l,u,f,m;if(o(this,C)&&this.hasListeners()){const h=o(this,O).variables,p=o(this,O).context;(e==null?void 0:e.type)==="success"?((r=(s=o(this,C)).onSuccess)==null||r.call(s,e.data,h,p),(c=(a=o(this,C)).onSettled)==null||c.call(a,e.data,null,h,p)):(e==null?void 0:e.type)==="error"&&((u=(l=o(this,C)).onError)==null||u.call(l,e.error,h,p),(m=(f=o(this,C)).onSettled)==null||m.call(f,void 0,e.error,h,p))}this.listeners.forEach(h=>{h(o(this,O))})})},H);function fe(t,e){const s=se(),[r]=i.useState(()=>new de(s,t));i.useEffect(()=>{r.setOptions(t)},[r,t]);const a=i.useSyncExternalStore(i.useCallback(l=>r.subscribe(Q.batchCalls(l)),[r]),()=>r.getCurrentResult(),()=>r.getCurrentResult()),c=i.useCallback((l,u)=>{r.mutate(l,u).catch(re)},[r]);if(a.error&&ne(r.options.throwOnError,[a.error]))throw a.error;return{...a,mutate:c,mutateAsync:a.mutate}}var A=function(){return A=Object.assign||function(t){for(var e,s=1,r=arguments.length;s<r;s++){e=arguments[s];for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a])}return t},A.apply(this,arguments)},me=function(t,e){var s={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(s[r]=t[r]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var a=0,r=Object.getOwnPropertySymbols(t);a<r.length;a++)e.indexOf(r[a])<0&&Object.prototype.propertyIsEnumerable.call(t,r[a])&&(s[r[a]]=t[r[a]]);return s},pe=ae("GridLoader","0% {transform: scale(1)} 50% {transform: scale(0.5); opacity: 0.7} 100% {transform: scale(1); opacity: 1}","grid"),j=function(t){return Math.random()*t};function xe(t){var e=t.loading,s=e===void 0?!0:e,r=t.color,a=r===void 0?"#000000":r,c=t.speedMultiplier,l=c===void 0?1:c,u=t.cssOverride,f=u===void 0?{}:u,m=t.size,h=m===void 0?15:m,p=t.margin,g=p===void 0?2:p,S=me(t,["loading","color","speedMultiplier","cssOverride","size","margin"]),b=W(h),L=W(g),w=parseFloat(b.value.toString())*3+parseFloat(L.value.toString())*6,k=A({width:"".concat(w).concat(b.unit),fontSize:0,display:"inline-block"},f),d=function(v){return{display:"inline-block",backgroundColor:a,width:"".concat(B(h)),height:"".concat(B(h)),margin:B(g),borderRadius:"100%",animationFillMode:"both",animation:"".concat(pe," ").concat((v/100+.6)/l,"s ").concat(v/100-.2,"s infinite ease")}};return s?i.createElement("span",A({style:k},S,{ref:function(v){v&&v.style.setProperty("width","".concat(w).concat(b.unit),"important")}}),i.createElement("span",{style:d(j(100))}),i.createElement("span",{style:d(j(100))}),i.createElement("span",{style:d(j(100))}),i.createElement("span",{style:d(j(100))}),i.createElement("span",{style:d(j(100))}),i.createElement("span",{style:d(j(100))}),i.createElement("span",{style:d(j(100))}),i.createElement("span",{style:d(j(100))}),i.createElement("span",{style:d(j(100))})):null}/**
 * @license lucide-react v0.479.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m16 12-4-4-4 4",key:"177agl"}],["path",{d:"M12 16V8",key:"1sbj14"}]],ge=V("CircleArrowUp",ye);/**
 * @license lucide-react v0.479.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]],ve=V("CirclePlus",be);/**
 * @license lucide-react v0.479.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=[["rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",key:"zuxfzm"}],["rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",key:"1okwgv"}]],je=V("Pause",we),Ce=({user:t,assistant:e})=>n.jsxs("div",{className:"w-full mx-auto p-4 bg-white",children:[t&&n.jsx("div",{className:"flex justify-end",children:n.jsx("div",{className:"p-2 rounded-lg text-base bg-primary text-white",children:n.jsx("span",{className:"break-words",children:t})})}),e&&n.jsxs("div",{className:"flex items-start space-x-2 w-full mt-10",children:[n.jsx("img",{className:"w-9 h-9 rounded-full",src:ue,alt:"logo"}),n.jsx("div",{className:"flex max-w-xl text-gray-500 text-base bg-gray-100 p-2 rounded-lg",children:n.jsx("span",{className:"break-words",children:e.split("<br />").map((s,r)=>n.jsxs("span",{children:[s,n.jsx("br",{})]},r))})})]})]});function Ee(t){const e=new TextDecoder,s=new TextEncoder;let r="";const a=new TransformStream({async transform(c,l){var g,S,b;const u=e.decode(c,{stream:!0}),f=r+u;let m="";const h=f.split(`
`);f.endsWith(`
`)||(m=h.pop()??"");let p="";for(const L of h){const w=L.trim();if(w&&w.startsWith("data:")){const k=w.slice(5).trim();if(k==="[DONE]")continue;try{const d=JSON.parse(k.replace(/\\n/g,"<br />")),v=(b=(S=(g=d==null?void 0:d.choices)==null?void 0:g[0])==null?void 0:S.delta)==null?void 0:b.content;typeof v=="string"&&(p+=v)}catch(d){console.error("Lỗi JSON:",d,"Dữ liệu lỗi:",k)}}}r=m,l.enqueue(s.encode(p))},flush(c){r&&c.enqueue(s.encode(r))}});return t.pipeThrough(a)}const Se=$.create({baseURL:"https://server2.loca.lt"}),Ne=async(t,e,s)=>{let r=0;await Se.post("/v1/chat/completions",{model:"Vistral-7B-Chat",messages:[{role:"user",content:t}],max_tokens:200,stream:!0},{responseType:"text",cancelToken:s,onDownloadProgress:a=>{const l=a.event.target.responseText,u=l.substring(r);r=l.length;const f=new ReadableStream({start(g){g.enqueue(new TextEncoder().encode(u)),g.close()}}),h=Ee(f).getReader(),p=new TextDecoder;h.read().then(({value:g,done:S})=>{if(S)return;const b=p.decode(g,{stream:!0});b&&e(b)})}})};function Oe(){return n.jsx("div",{className:"flex items-center justify-center h-full",children:n.jsx(xe,{color:"#00c8ff",size:20})})}const G=i.createContext({}),ke=({children:t})=>{const{isUser:e}=ie(),{currentChatId:s}=he(),[r,a]=i.useState(""),[c,l]=i.useState([]),[u,f]=i.useState(!1),m=i.useRef(null),{isLoading:h,isRefetching:p,refetch:g}=oe({queryKey:["listChat"],queryFn:async()=>{const{data:x}=await le(s);return l(x),x},enabled:!1,retry:!1}),{mutate:S,isError:b,isPaused:L,error:w,isPending:k}=fe({mutationFn:async x=>{f(!0),m.current=$.CancelToken.source();let P="";await Ne(x,X=>{f(!1),P+=X,l(Y=>{const q=[...Y];return q[q.length-1].assistant=P,[...q]})},m.current.token),f(!1),d()}}),d=async()=>{try{const{user:x,assistant:P}=c[c.length-1];await ce(s,x,P)}catch(x){console.error(x)}},v=x=>{if(c.length>5&&!e){F.warn("Vui lòng đăng nhập để có thể tiếp tục chat");return}e||F.warn("Đoạn chat của bạn sẽ không được lưu, Vui lòng đăng nhập"),l(P=>[...P,{user:x,assistant:""}]),S(x)},U=()=>{m.current&&m.current.cancel("Người dùng đã hủy request!"),f(!1)};return i.useEffect(()=>{const x=()=>{U()};return window.addEventListener("beforeunload",x),()=>{window.removeEventListener("beforeunload",x)}},[]),i.useEffect(()=>(s&&g(),()=>{U()}),[s,g]),i.useEffect(()=>{b&&f(!1)},[b,w]),h||p?n.jsx(Oe,{}):n.jsx(G.Provider,{value:{prompt:r,isError:b,error:w,listChat:c,loadingResAt:u,isPending:k,isPaused:L,sendMessage:v,setPrompt:a,stopChat:U},children:t})},J=()=>{const t=i.useContext(G);if(!t)throw new Error("useChat must be used within ChatBotProvider");return t},Pe=()=>{const{listChat:t,loadingResAt:e,isError:s,error:r}=J();return t.length?n.jsx("div",{className:"w-full flex-1 max-h-[768px] overflow-y-auto",children:n.jsx("div",{className:"min-w-[768px] max-md:min-w-full flex justify-center",children:n.jsxs("div",{className:"flex flex-col w-full max-w-2xl space-y-3 mb-4 ",children:[t.map((a,c)=>n.jsx(Ce,{user:a.user,assistant:a.assistant},c)),e&&n.jsx("span",{children:"Vui lòng chờ...."}),s&&r.code!=="ERR_CANCELED"&&n.jsx("span",{className:"text-red-500",children:"Xảy ra lỗi vui lòng thử lại"})]})})}):n.jsx("div",{className:"w-full text-center text-4xl p-4",children:n.jsx("h1",{children:"Tôi có thể giúp gì cho sức khỏe của bạn"})})},Me=()=>{const{prompt:t,setPrompt:e,sendMessage:s,stopChat:r,isPending:a,isPaused:c}=J(),l=u=>{u.preventDefault(),!(!t.trim()||a)&&(s(t),e(""))};return n.jsx("div",{className:"flex w-full mb-10 justify-center items-center",children:n.jsxs("form",{onSubmit:l,className:"flex items-center justify-between min-w-[768px] bg-gradient-to-r from-primary to-blue-600 rounded-full px-4 py-2 shadow-md",children:[n.jsx("button",{type:"button",className:"p-2 text-white hover:opacity-70",children:n.jsx(ve,{className:"w-8 h-8"})}),n.jsx("input",{type:"text",className:"flex-1 bg-white px-4 py-1 rounded-full outline-none text-gray-700 mx-4",placeholder:"Hỏi bất cứ điều gì về sức khỏe của bạn",value:t,onChange:u=>e(u.target.value)}),a&&!c?n.jsx("button",{type:"button",className:"p-2 text-white hover:opacity-70",onClick:r,children:n.jsx(je,{})}):n.jsx("button",{type:"submit",className:"p-2 text-white hover:opacity-70",children:n.jsx(ge,{className:"w-8 h-8"})})]})})},_e=()=>n.jsx("div",{className:"w-full h-full flex flex-col justify-center items-center",children:n.jsxs(ke,{children:[n.jsx(Pe,{}),n.jsx(Me,{})]})});export{_e as default};
